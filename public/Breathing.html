<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>4-4-4-4 Breathing Routine (3 min) — Prototype</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#60a5fa;
      --muted:#94a3b8;
      --white:#e6eef8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:linear-gradient(180deg,var(--bg),#08121a 60%);
      color:var(--white);
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      padding:24px;
    }
    .card{
      width:100%;
      max-width:760px;
      background:linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:26px;
      box-shadow:0 10px 30px rgba(2,6,23,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{font-size:18px;margin:0}
    p.lead{margin:6px 0 18px;color:var(--muted);font-size:13px}
    .main{
      display:flex;
      gap:22px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .visual{
      width:320px;height:320px;
      display:flex;align-items:center;justify-content:center;
      position:relative;
    }
    .circle{
      width:220px;height:220px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      background: radial-gradient(circle at 35% 25%, rgba(96,165,250,0.12), transparent 25%),
                  linear-gradient(180deg, rgba(96,165,250,0.07), rgba(6,10,14,0.2));
      border:1px solid rgba(96,165,250,0.12);
      transition: width 0.9s ease, height 0.9s ease;
      box-shadow: 0 10px 30px rgba(6,10,14,0.6), inset 0 1px 8px rgba(255,255,255,0.02);
    }
    .phase{
      text-align:center;
    }
    .phase .name{font-size:20px;margin:0;font-weight:600}
    .phase .count{font-size:40px;margin:6px 0 0;font-weight:700}
    .controls{
      flex:1;
      min-width:260px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .controls .buttons{display:flex;gap:8px}
    button{
      padding:10px 14px;border-radius:8px;border:0;background:var(--accent);color:#012a4a;font-weight:700;
      cursor:pointer;box-shadow:0 6px 16px rgba(96,165,250,0.12);
    }
    button.secondary{background:transparent;color:var(--white);border:1px solid rgba(255,255,255,0.06);font-weight:600}
    .small{padding:8px 10px;font-size:14px}
    .meta{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label.switch{display:inline-flex;gap:8px;align-items:center;cursor:pointer}
    input[type="range"]{width:150px}
    .progress{
      height:10px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden;margin-top:6px;
    }
    .progress > i{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent), #7dd3fc)}
    footer{margin-top:16px;color:var(--muted);font-size:12px}
    .muted{color:var(--muted);font-size:13px}
    .controls .settings{display:flex;flex-direction:column;gap:8px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)}
    .linklike{background:transparent;border:0;color:var(--accent);cursor:pointer}
    @media(max-width:720px){
      .visual{width:100%;height:260px}
      .circle{width:180px;height:180px}
    }
  </style>
</head>
<body>
  <div class="card" role="application" aria-label="4-4-4-4 breathing routine">
    <header>
      <div>
        <h1>4-4-4-4 Breathing — Audio Prototype</h1>
        <p class="lead">Inhale 4s → Hold 4s → Exhale 4s → Hold 4s. Default session: <strong>3 minutes</strong>.</p>
      </div>
      <div class="muted">Prototype — no external audio files (Web Audio + SpeechSynthesis)</div>
    </header>

    <div class="main">
      <div class="visual" aria-hidden="false">
        <div id="circle" class="circle" aria-hidden="true">
          <div style="text-align:center;color:var(--muted)">
            <div style="font-size:13px">Phase</div>
            <div id="phaseName" class="name" style="color:var(--white);font-size:18px">Idle</div>
            <div id="phaseCount" class="count" style="font-size:28px">0</div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="buttons" role="toolbar" aria-label="session controls">
          <button id="startBtn">Start</button>
          <button id="pauseBtn" class="secondary small">Pause</button>
          <button id="stopBtn" class="secondary small">Stop</button>
          <button id="muteBtn" class="secondary small">Mute: Off</button>
        </div>

        <div class="settings">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <label class="muted">Session length (minutes)</label><br/>
              <input id="durationInput" type="number" min="0.5" max="60" step="0.5" value="3" style="width:86px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--white)">
            </div>

            <div>
              <label class="muted">Voice prompts</label><br/>
              <label class="switch">
                <input id="voiceToggle" type="checkbox" checked>
                <span class="muted">Enabled</span>
              </label>
            </div>
          </div>

          <div style="display:flex;align-items:center;justify-content:space-between">
            <div>
              <div class="muted">Remaining</div>
              <div id="remaining" style="font-weight:800;font-size:18px">03:00</div>
            </div>
            <div style="width:55%">
              <div class="muted">Session progress</div>
              <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
                <i id="progressBar"></i>
              </div>
            </div>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="muted">Cycle: <strong id="cycleNum">0</strong></div>
          <div><button id="quickReset" class="secondary small">Reset to 3m</button></div>
        </div>
      </div>
    </div>

    <footer>
      Tip: use the Mute toggle to silence tones; keep Voice prompts on for spoken guidance. Works offline — no external audio.
    </footer>
  </div>

  <script>
    // --- Config & state
    const PHASES = [
      {name:'Inhale', duration:4, action:'inhale'},
      {name:'Hold', duration:4, action:'hold'},
      {name:'Exhale', duration:4, action:'exhale'},
      {name:'Hold', duration:4, action:'hold'}
    ];
    let durationMinutesInput = document.getElementById('durationInput');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const muteBtn = document.getElementById('muteBtn');
    const voiceToggle = document.getElementById('voiceToggle');
    const circle = document.getElementById('circle');
    const phaseName = document.getElementById('phaseName');
    const phaseCount = document.getElementById('phaseCount');
    const remainingEl = document.getElementById('remaining');
    const progressBar = document.getElementById('progressBar');
    const cycleNumEl = document.getElementById('cycleNum');
    const quickReset = document.getElementById('quickReset');

    // session state
    let sessionSeconds = Math.round(parseFloat(durationMinutesInput.value) * 60);
    let elapsed = 0;
    let sessionTimer = null;
    let phaseIndex = -1;
    let phaseRemaining = 0;
    let isRunning = false;
    let isPaused = false;
    let isMuted = false;
    let cycleCount = 0;

    // Audio setup (Web Audio API) - lightweight tone for cues
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null;

    function ensureAudioCtx() {
      if (!audioCtx) audioCtx = new AudioContext();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      return audioCtx;
    }

    function playTone(freq=880, duration=0.15, type='sine') {
      if (isMuted) return;
      try {
        const ac = ensureAudioCtx();
        const o = ac.createOscillator();
        const g = ac.createGain();
        o.type = type;
        o.frequency.value = freq;
        g.gain.value = 0.0001;
        o.connect(g); g.connect(ac.destination);
        const now = ac.currentTime;
        g.gain.setTargetAtTime(0.12, now, 0.01);
        o.start(now);
        g.gain.setTargetAtTime(0.0001, now + duration, 0.02);
        o.stop(now + duration + 0.03);
      } catch(e) {
        // ignore
      }
    }

    // SpeechSynthesis prompts
    function speak(text) {
      if (!voiceToggle.checked || isMuted) return;
      if (!('speechSynthesis' in window)) return;
      try {
        // prefer a short, calm voice
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = 1;
        utter.pitch = 0.9;
        utter.volume = 0.9;
        // choose a default voice if available
        const voices = speechSynthesis.getVoices();
        if (voices && voices.length) {
          // prefer a neutral voice (non-robotic)
          utter.voice = voices.find(v => /en|female|Google/i.test(v.name)) || voices[0];
        }
        speechSynthesis.cancel();
        speechSynthesis.speak(utter);
      } catch(e) {}
    }

    // Helpers
    function formatTime(s) {
      const mm = Math.floor(s/60).toString().padStart(2,'0');
      const ss = Math.max(0, s % 60).toString().padStart(2,'0');
      return `${mm}:${ss}`;
    }

    function resetSession() {
      stopSpeech();
      if (sessionTimer) { clearInterval(sessionTimer); sessionTimer = null; }
      elapsed = 0;
      phaseIndex = -1;
      phaseRemaining = 0;
      isRunning = false;
      isPaused = false;
      cycleCount = 0;
      sessionSeconds = Math.round(parseFloat(durationMinutesInput.value) * 60);
      remainingEl.textContent = formatTime(sessionSeconds);
      progressBar.style.width = '0%';
      cycleNumEl.textContent = '0';
      phaseName.textContent = 'Idle';
      phaseCount.textContent = '0';
      circle.style.width = '220px';
      circle.style.height = '220px';
      startBtn.disabled = false;
    }

    function stopSpeech() {
      if ('speechSynthesis' in window) speechSynthesis.cancel();
    }

    function startSession() {
      if (isRunning) return;
      if (sessionSeconds <= 0) return;
      isRunning = true;
      isPaused = false;
      startBtn.disabled = true;
      // begin with phase 0
      nextPhase();
      sessionTimer = setInterval(tick, 200); // 200ms tick for smooth UI
    }

    function pauseSession() {
      if (!isRunning) return;
      isPaused = !isPaused;
      if (isPaused) {
        pauseBtn.textContent = 'Resume';
        stopSpeech();
      } else {
        pauseBtn.textContent = 'Pause';
      }
    }

    function stopSession() {
      resetSession();
    }

    function tick() {
      if (!isRunning || isPaused) return;
      elapsed += 0.2;
      const remaining = Math.max(0, Math.round(sessionSeconds - elapsed));
      remainingEl.textContent = formatTime(remaining);
      const pct = Math.min(100, Math.round((elapsed / sessionSeconds) * 100));
      progressBar.style.width = pct + '%';
      if (phaseRemaining > 0) {
        // decrement by tick
        // using small steps to keep smooth
        phaseRemaining -= 0.2;
        phaseCount.textContent = Math.max(0, Math.ceil(phaseRemaining));
      } else {
        // phase ended, move to next
        nextPhase();
      }
      // if time is over stop
      if (elapsed >= sessionSeconds - 0.001) {
        finishSession();
      }
    }

    function finishSession() {
      playTone(1100, 0.35, 'triangle');
      speak('Session complete. Well done.');
      stopSession();
    }

    function nextPhase() {
	debugger;
      phaseIndex = (phaseIndex + 1) % PHASES.length;
      const cur = PHASES[phaseIndex];
      // if we've just completed a full cycle (phaseIndex === 0 after not -1), increment cycle count
      if (phaseIndex === 0 && elapsed > 0) cycleCount++;
      cycleNumEl.textContent = cycleCount.toString();
      phaseName.textContent = cur.name;
      phaseRemaining = cur.duration;
      phaseCount.textContent = cur.duration;
      // visual animation for inhale/exhale
      if (cur.action === 'inhale') {
        animateCircle(260, 260, cur.duration);
        playTone(880, 0.15, 'sine');
        speak('Inhale for four seconds');
      } else if (cur.action === 'exhale') {
        animateCircle(140, 140, cur.duration);
        playTone(440, 0.15, 'sine');
        speak('Exhale for four seconds');
      } else { // hold
        // small pulse
        animateCircle(200, 200, cur.duration);
        playTone(660, 0.12, 'sawtooth');
        speak(cur.name === 'Hold' ? 'Hold' : cur.name + ' for four seconds');
      }
    }

    // circle size animation using CSS transitions
    function animateCircle(w, h, durationSec) {
      // transition-duration slightly less to feel responsive
      circle.style.transition = 'width ' + Math.max(0.5, durationSec * 0.9) + 's ease, height ' + Math.max(0.5, durationSec * 0.9) + 's ease';
      circle.style.width = w + 'px';
      circle.style.height = h + 'px';
    }

    // UI wiring
    startBtn.addEventListener('click', () => {
      // ensure audio context exists on user gesture (some browsers require)
      try { ensureAudioCtx(); } catch(e){}
      sessionSeconds = Math.round(parseFloat(durationMinutesInput.value) * 60);
      if (isNaN(sessionSeconds) || sessionSeconds <= 0) {
        alert('Enter a valid session length in minutes (min 0.5).');
        return;
      }
      startSession();
    });

    pauseBtn.addEventListener('click', () => {
      pauseSession();
    });

    stopBtn.addEventListener('click', () => {
      stopSession();
    });

    muteBtn.addEventListener('click', () => {
      isMuted = !isMuted;
      muteBtn.textContent = 'Mute: ' + (isMuted ? 'On' : 'Off');
      muteBtn.classList.toggle('secondary', !isMuted);
      if (isMuted) stopSpeech();
    });

    durationMinutesInput.addEventListener('change', () => {
      // update sessionSeconds only when not running
      if (!isRunning) {
        sessionSeconds = Math.round(parseFloat(durationMinutesInput.value) * 60);
        remainingEl.textContent = formatTime(sessionSeconds);
      }
    });

    quickReset.addEventListener('click', () => {
      durationMinutesInput.value = 3;
      durationMinutesInput.dispatchEvent(new Event('change'));
      resetSession();
    });

    // init UI
    resetSession();

    // Accessibility: keyboard shortcuts (space: start/pause, s: stop, m: mute)
    window.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      if (e.code === 'Space') { e.preventDefault(); if (!isRunning) startBtn.click(); else pauseBtn.click(); }
      if (e.key === 's') stopBtn.click();
      if (e.key === 'm') muteBtn.click();
    });

    // Handle page visibility: pause audio when hidden
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        if (audioCtx && audioCtx.state === 'running') {
          // optional - don't suspend automatically to avoid user annoyance
        }
      }
    });

    // ensure voices loaded for speechSynthesis
    if ('speechSynthesis' in window) {
      speechSynthesis.onvoiceschanged = () => { /* just make voices available */ };
    }
  </script>
</body>
</html>
